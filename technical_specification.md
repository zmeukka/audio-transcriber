# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Программа автоматической транскрипции аудиофайлов с использованием WhisperX

### 1. ОБЩЕЕ ОПИСАНИЕ ПРОЕКТА

**Цель проекта:** Разработать программу для автоматического преобразования аудиофайлов в текст с использованием библиотеки WhisperX.

**Назначение:** Программа предназначена для массовой обработки аудиофайлов (например, записей разговоров из Telegram) и получения их текстовых расшифровок с возможностью идентификации говорящих.

### 2. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

#### 2.1 Платформа и язык разработки
- **Язык программирования:** Python 3.8+
- **Основная библиотека:** WhisperX
- **Язык комментариев в коде:** Английский (все комментарии должны быть написаны на английском языке)
- **Операционная система:** Windows, Linux, macOS

#### 2.2 Архитектура программы
Программа должна состоять из следующих компонентов:
- Основной исполняемый модуль
- Модуль конфигурации
- Модуль обработки аудио (через консольную утилиту WhisperX)
- Модуль управления файлами
- Модуль логирования
- Модуль управления внешними процессами (для запуска WhisperX)

### 3. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

#### 3.1 Файл конфигурации (config.yaml)
Программа должна использовать файл настроек в формате YAML со следующими параметрами:

```yaml
# Пути к директориям
input_directory: "путь/к/входной/папке"        # Папка с аудиофайлами для обработки
output_directory: "путь/к/выходной/папке"      # Папка для сохранения результатов
manual_processing_directory: "путь/к/папке/ручной/обработки"  # Папка для проблемных файлов

# Настройки WhisperX
whisperx:
  model_size: "base"                            # Размер модели (tiny, base, small, medium, large)
  language: "ru"                               # Язык распознавания (ru, en, de, fr, es, etc.)
  temperature: 0.1                             # Температура для точности (0.1 для лучшего качества)
  compute_type: "int8"                         # Тип вычислений (float32, float16, int8)
  device: "cpu"                                # Устройство (cpu, cuda)
  debug: false                                 # Отладочный вывод

# Настройки обработки
processing:
  max_retry_attempts: 3                        # Максимальное количество попыток обработки
```

#### 3.2 Логика работы программы

##### 3.2.1 Сканирование входной директории
- Программа сканирует входную папку на наличие аудиофайлов
- Поддерживаемые форматы: .mp3, .wav, .m4a, .ogg, .flac
- Имена файлов могут быть любыми, но обычно имеют формат: `telegramID+salt.расширение`

##### 3.2.2 Определение статуса файла
Для каждого аудиофайла программа проверяет наличие служебных файлов:
- `filename.in_process` - файл процесса обработки (содержит также информацию об ошибках)
- `filename.txt` - готовая расшифровка

**Статусы файлов:**
- **Не обработан** - отсутствуют все служебные файлы
- **В процессе** - существует файл `.in_process` без ошибок в секции ERRORS
- **Ошибка** - существует файл `.in_process` с записями в секции ERRORS
- **Завершен** - существует файл `.txt` и отсутствует `.in_process`

##### 3.2.3 Алгоритм обработки

**Для необработанных файлов:**
1. Создать файл `filename.in_process`
2. Записать в него начальную информацию:
   ```
   Начало обработки: [дата и время]
   Файл: [имя файла]
   Попытка: 1
   Processing time: 0 seconds
   ```
3. Запустить консольную команду WhisperX для транскрипции

**Команда WhisperX:**
```bash
whisperx [audio_file] --model [model_size] --language [language] --temperature [temperature] --compute_type [compute_type] --device [device] --output_dir [temp_output] --output_format json
```

**Параметры команды (из config.yaml):**
- `[audio_file]` - путь к аудиофайлу для обработки
- `--model [model_size]` - размер модели из конфигурации (рекомендуется: base для качества, tiny для скорости)
- `--language [language]` - язык из конфигурации (обязательно ru для русского языка)
- `--temperature [temperature]` - температура для точности (0.1 для лучшего качества)
- `--compute_type [compute_type]` - тип вычислений (int8 оптимален для CPU)
- `--device [device]` - устройство обработки (cpu рекомендуется)
- `--output_dir [temp_output]` - временная папка для результатов
- `--output_format json` - формат вывода с временными метками

**Для файлов в процессе:**
1. Прочитать файл `.in_process`
2. Определить текущее состояние обработки
3. Продолжить с места остановки или перезапустить WhisperX
4. Увеличить счетчик попыток

**При превышении лимита попыток (3 раза):**
1. Переместить оригинальный файл в папку ручной обработки
2. Переместить все связанные служебные файлы
3. Создать отчет о проблеме

#### 3.3 Обработка результатов WhisperX
**Выходные файлы WhisperX:**
- WhisperX создает файлы в указанной временной папке
- Основные форматы: `.txt`, `.srt`, `.vtt`, `.json`
- Используется `.json` формат с временными метками

**Алгоритм обработки результатов:**
1. Программа ожидает завершения процесса WhisperX
2. Проверяет код возврата процесса (0 = успех)
3. Парсит выходные файлы WhisperX (.json)
4. Извлекает текст и временные метки из результатов
5. Формирует финальный `.txt` файл по заданному формату
6. Удаляет временные файлы WhisperX и файлы со звуком если финальный txt файл существует

**Обработка транскрипции:**
- Извлечение текста из JSON результатов WhisperX
- Форматирование с временными метками
- Сохранение в итоговый .txt файл без разделения на говорящих

**Отслеживание времени обработки:**
- В начале обработки записывается `Processing time: 0 seconds`
- Время обновляется по завершении обработки (успешной или с ошибкой)
- Формат времени: `45.3 seconds`, `1m 30.5s`, `1h 15m 30.5s`
- Время записывается в лог как для успешных, так и для неудачных обработок

**Результаты экспериментов по оптимизации:**
На основе проведенных экспериментов установлены оптимальные параметры:

| Модель | Язык | Compute Type | Temperature | Результат для "Ты сакс" |
|--------|------|-------------|-------------|-------------------------|
| tiny   | ru   | float32     | 0.98        | "Писокс" ❌            |
| base   | ru   | int8        | 0.1         | "Ты сакс" ✅           |
| small  | ru   | int8        | 0.1         | "Ты, Сакс" ✅         |
| medium | ru   | int8        | 0.1         | "This sucks" ❌        |

**Рекомендации:**
- Модель `base` обеспечивает оптимальное соотношение качества и скорости
- Принудительное указание `language: "ru"` критично для русской речи
- `compute_type: "int8"` обеспечивает высокую производительность без потери качества
- `temperature: 0.1` повышает точность распознавания коротких фраз
- Модель `medium` склонна переключаться на английский язык, не рекомендуется

#### 3.4 Структура файла .in_process
```
Processing started: 2025-10-29 14:30:15
File: audio_recording_001.mp3
Attempt: 1
Processing time: 45.3 seconds
---
[intermediate transcription results saved here during processing]

=== ERRORS (if any) ===
Error date: 2025-10-29 14:35:22
Attempt: 1
Error: Failed to load audio file
Details: WhisperX process failed
---
Error date: 2025-10-29 15:00:10
Attempt: 2
Error: Timeout exceeded
Details: WhisperX process failed
---
```

**Примечание:** Секция ERRORS содержит информацию о всех ошибках для данного файла. Если ошибок нет, секция остается пустой.

#### 3.5 Структура выходного файла .txt
```
=== РАСШИФРОВКА АУДИОЗАПИСИ ===
Файл: audio_recording_001.mp3
Дата обработки: 2025-10-29 14:45:30
Продолжительность: 00:05:23
Расшифровка заняла: 29.1 seconds

=== ТРАНСКРИПЦИЯ ===
[00:00:00] Привет, как дела?
[00:00:05] Хорошо, спасибо. А у тебя?
[00:00:10] Тоже неплохо, работаю над проектом.
[00:00:15] А я вчера фильм интересный смотрела.
...
```

### 4. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

#### 4.1 Производительность
- Программа должна обрабатывать файлы последовательно
- Возможность паузы и возобновления обработки
- Отображение прогресса обработки (опционально)
- Только один рабочий экземпляр программы в данный момент времени
- **Блокировка процессов:** Использовать простой файл-блокировку (lock file) в выходной директории
- **Требования к ресурсам:** Максимум 2 ядра CPU и 2GB памяти
- **Приоритет:** Качество обработки важнее скорости

#### 4.2 Надежность
- Автоматическое восстановление после сбоев
- Сохранение промежуточных результатов
- Логирование всех операций
- **Критерии перемещения в папку ручной обработки:** Три неудачные попытки запуска консольной утилиты WhisperX с ошибками


### 5. ТРЕБОВАНИЯ К ИНТЕРФЕЙСУ

#### 5.1 Консольный интерфейс
- Запуск: `python transcriber.py`
- Параметры командной строки:
  - `--file *имя файла*` - Обработка определенного файла
  - `--test` - Тестовый режим (обработка sample.oga)
  - `--fast` - Быстрый режим с pre-warmed моделями
  - `--config *путь*` - Путь к файлу конфигурации
  - `--verbose` - Подробный вывод
  
Без параметров - обработка всех файлов в папке.

#### 5.1.1 Быстрый режим (Fast Mode)
**Назначение:** Ускорение повторных запусков за счет предварительной загрузки моделей в память.

**Использование:**
```bash
# 1. Первоначальный pre-warming (один раз)
python prewarmer.py                    # ~20-30 секунд

# 2. Быстрая обработка (повторные запуски)
python transcriber.py --fast --test    # ~2-5 секунд
python transcriber.py --fast --file input/audio.oga  # ~2-10 секунд
```

**Ограничения быстрого режима:**
- Поддерживает только обработку одного файла (`--file` или `--test`)
- Не поддерживает пакетную обработку всех файлов
- Требует предварительного pre-warming
- Высокое потребление памяти (~2-3GB)

**Преимущества:**
- Ускорение в 10-20 раз для повторных запусков
- Модели остаются загруженными в памяти
- Минимальные накладные расходы на инициализацию


#### 5.2 Вывод информации
- Простые текстовые сообщения о текущем статусе
- Информация об обработанных файлах
- Сообщения об ошибках
- Время начала и окончания обработки

### 6. ТРЕБОВАНИЯ К УСТАНОВКЕ И РАЗВЕРТЫВАНИЮ

#### 6.1 Установка WhisperX
**Важно:** Программа должна использовать консольную утилиту WhisperX, а не библиотеку напрямую.

**Предварительные требования:**
1. Python 3.8+ (рекомендуется Python 3.12)
2. Git
3. FFmpeg (для обработки аудиофайлов)

**Пошаговая установка:**

**Шаг 1: Установка FFmpeg**
- **Windows:** Скачать с https://ffmpeg.org/download.html и добавить в PATH
- **Linux:** `sudo apt update && sudo apt install ffmpeg`
- **macOS:** `brew install ffmpeg`

**Шаг 2: Создание виртуального окружения**
```bash
python -m venv .venv
# Windows:
.venv\Scripts\Activate.ps1
# Linux/macOS:
source .venv/bin/activate
```

**Шаг 3: Установка PyTorch (совместимые версии)**
```bash
pip install torch==2.8.0 torchaudio==2.8.0
```

**Шаг 4: Установка WhisperX**
```bash
pip install whisperx
```

**Шаг 5: Проверка установки**
```bash
whisperx --help
```

**Решение проблем с кодировкой (Windows):**
Для корректной работы с русским текстом в Windows PowerShell:
```powershell
$env:PYTHONIOENCODING="utf-8"
$env:PYTHONUTF8="1"
```

Или добавить в начало Python скрипта:
```python
import sys
if sys.platform == "win32":
    import codecs
    sys.stdout = codecs.getwriter("utf-8")(sys.stdout.detach())
    sys.stderr = codecs.getwriter("utf-8")(sys.stderr.detach())
```

#### 6.2 Зависимости проекта
```
pyyaml>=6.0
psutil>=5.9.0
whisperx>=3.7.0
torch==2.8.0
torchaudio==2.8.0
```

**Примечание:** Версии torch и torchaudio зафиксированы для обеспечения совместимости с WhisperX.

#### 6.3 Установка программы
1. Убедиться, что WhisperX установлен и работает (команда `whisperx --help`)
2. Установить зависимости проекта: `pip install -r requirements.txt`
3. Настроить файл `config.yaml`
4. Запустить программу: `python transcriber.py`

#### 6.3 Структура проекта
```
audio_transcriber/
├── transcriber.py          # Основной файл программы
├── prewarmer.py           # Pre-warming модуль для быстрого режима
├── fast_transcriber.py    # Быстрый транскрибер
├── start_prewarmer.ps1    # Запуск pre-warming для Windows
├── start_prewarmer.sh     # Запуск pre-warming для Linux/Ubuntu
├── config.yaml            # Файл конфигурации
├── requirements.txt       # Зависимости
├── cache/                 # Кэш pre-warming системы
├── samples/               # Директория с тестовыми аудиофайлами
│   ├── test_audio.mp3     # Пример аудиофайла для тестирования
│   └── README.md          # Описание тестовых файлов
├── modules/
│   ├── __init__.py
│   ├── audio_processor.py  # Модуль обработки аудио
│   ├── file_manager.py     # Модуль управления файлами
│   ├── config_loader.py    # Модуль загрузки конфигурации
│   └── logger.py          # Модуль логирования
└── README.md              # Документация
```

### 7. КРИТЕРИИ ПРИЕМКИ

#### 7.1 Функциональность
- ✅ Программа успешно загружает конфигурацию из YAML файла
- ✅ Корректно обрабатывает аудиофайлы различных форматов
- ✅ Создает и ведет файлы .in_process (включая секцию ошибок)
- ✅ Возобновляет обработку после прерывания
- ✅ Перемещает проблемные файлы в папку ручной обработки
- ✅ Идентифицирует пользователей по ID и алиасам
- ✅ Поддерживает быстрый режим с pre-warmed моделями
- ✅ Отображает время обработки в выходных файлах

#### 7.2 Качество
- ✅ Код документирован и понятен
- ✅ Весь код должен быть коротко откомментирован на английском языке
- ✅ Комментарии могут и должны использоваться AI для разметки и понимания структуры кода
- ✅ Обработка ошибок реализована корректно
- ✅ Логирование работает правильно
- ✅ Программа стабильно работает с большими объемами данных

### 8. ДОПОЛНИТЕЛЬНЫЕ ЗАМЕЧАНИЯ

- Программа должна быть понятна пользователю без технического образования
- Все сообщения об ошибках должны быть написаны простым языком
- Необходимо предусмотреть подробную документацию по установке и использованию
- Рекомендуется создать примеры файлов конфигурации

### 9. ТЕХНИЧЕСКИЕ РЕШЕНИЯ

#### 9.1 Блокировка процессов
**Реализация:** Проверка активных процессов WhisperX в системе
- При запуске программы проверять наличие активных процессов `whisperx` через `psutil`
- Если найден активный процесс WhisperX - завершать работу с сообщением "WhisperX уже выполняется"
- Периодически проверять статус процесса во время обработки
- Это предотвращает конфликты при одновременном запуске нескольких экземпляров

#### 9.2 Обработка транскрипции
**Алгоритм обработки:**
- Обработка файлов с любыми именами (не обязательно формат `telegramID+salt`)
- Парсинг JSON результатов WhisperX для получения текста и временных меток
- Форматирование транскрипции с временными метками в едином потоке
- Без разделения на говорящих - вся речь представлена как единый поток
- Telegram ID извлекается только для логирования (если присутствует в имени файла)

#### 9.3 Критерии обработки ошибок
**Перемещение в папку ручной обработки:**
- Три неудачные попытки запуска консольной утилиты WhisperX
- Критерий неудачи: ненулевой код возврата процесса WhisperX
- После третьей ошибки: переместить файл + все служебные файлы

#### 9.4 Ресурсы и производительность
**Ограничения:**
- Максимум 2 ядра CPU
- Максимум 2GB памяти
- Приоритет: качество важнее скорости
- Последовательная обработка файлов (без параллелизма)

#### 9.5 Форматы и структуры данных
**Кодировка выходных файлов:** UTF-8 для всех текстовых файлов (.txt, .in_process)

**Детализация логирования:**
- Уровни логов: INFO, WARNING, ERROR
- Формат записи: `[YYYY-MM-DD HH:MM:SS] [LEVEL] [MODULE] Message`
- Вывод: консоль (stdout/stderr)
- Примеры записей:
  ```
  [2025-10-29 14:30:15] [INFO] [FileManager] Scanning input directory: /path/to/input
  [2025-10-29 14:30:16] [INFO] [AudioProcessor] Starting WhisperX for file: audio.mp3
  [2025-10-29 14:35:22] [ERROR] [AudioProcessor] WhisperX failed with code 1: CUDA out of memory
  ```

**Формат промежуточных результатов (.in_process):**
```
=== FILE PROCESSING ===
Processing started: 2025-10-29 14:30:15
File: 123456789_abc123.mp3
Attempt: 1
Status: In progress
Progress: 45%
WhisperX PID: 12345

=== INTERMEDIATE RESULTS ===
[Partial results saved as received from WhisperX]
```

#### 9.6 Надежность и безопасность

**Проверка целостности данных:**
- Проверять размер аудиофайла перед обработкой (не равен 0)
- Валидировать JSON выходные данные WhisperX перед парсингом
- Проверять доступность директорий для записи перед началом работы
- Контролировать свободное место на диске (минимум 0.1GB)


#### 9.7 Обработка прерываний (Ctrl+C)
- Перехватывать сигнал SIGINT
- Корректно завершать процесс WhisperX
- Сохранять текущее состояние в .in_process файл
- Выводить сообщение: "Обработка прервана пользователем. Состояние сохранено."
- Очищать временные файлы перед выходом

### 10. ROADMAP РАЗРАБОТКИ

#### 10.1 Этап 1: Инициализация проекта
- [x] **1.1** Создание структуры проекта (папки, основные файлы)
- [x] **1.2** Создание файла requirements.txt с зависимостями
- [x] **1.3** Создание базового config.yaml с примерами настроек
- [x] **1.4** Создание директории samples с тестовыми аудиофайлами
- [x] **1.5** Создание README.md с инструкциями по установке
- [x] **1.6** Инициализация git репозитория (опционально)

#### 10.2 Этап 2: Базовые модули
- [x] **2.1** Модуль config_loader.py - загрузка и валидация конфигурации
- [x] **2.2** Модуль logger.py - настройка логирования с ротацией
- [x] **2.3** Модуль file_manager.py - работа с файлами и директориями
- [x] **2.4** Базовые тесты для модулей конфигурации и логирования

#### 10.3 Этап 3: Обработка аудиофайлов
- [x] **3.1** Модуль audio_processor.py - запуск WhisperX через subprocess
- [x] **3.2** Функция парсинга JSON результатов WhisperX
- [x] **3.3** Функция форматирования выходного .txt файла
- [x] **3.4** Обработка ошибок WhisperX и retry логика
- [x] **3.5** Тестирование на файлах из директории samples/

#### 10.4 Этап 4: Управление состоянием файлов
- [x] **4.1** Создание и ведение .in_process файлов (включая секцию ошибок)
- [x] **4.2** Логика определения статуса файлов
- [x] **4.3** Функция восстановления обработки после прерывания
- [x] **4.4** Тестирование механизма восстановления

#### 10.5 Этап 5: Блокировка процессов
- [x] **5.1** Проверка активных процессов WhisperX через psutil
- [x] **5.2** Предотвращение запуска нескольких экземпляров
- [x] **5.3** Корректная обработка завершения процессов
- [x] **5.4** Тестирование блокировок на разных ОС

#### 10.6 Этап 6: Основной исполняемый файл
- [x] **6.1** Создание transcriber.py с аргументами командной строки
- [x] **6.2** Интеграция всех модулей в основной workflow
- [x] **6.3** Реализация режима обработки одного файла (--file)
- [x] **6.4** Реализация режима массовой обработки
- [x] **6.5** Базовое тестирование полного цикла с файлами из samples/

#### 10.7 Этап 7: Обработка ошибок и надежность
- [x] **7.1** Перемещение проблемных файлов в manual_processing
- [x] **7.2** Валидация входных данных и конфигурации
- [x] **7.3** Проверка свободного места на диске
- [ ] **7.4** Graceful shutdown при Ctrl+C
- [x] **7.5** Комплексное тестирование обработки ошибок

#### 10.8 Этап 8: Оптимизация и финализация
- [x] **8.1** Оптимизация использования памяти (≤2GB)
- [x] **8.2** Ограничение использования CPU (≤2 ядра)
- [x] **8.3** Очистка временных файлов
- [x] **8.4** Финальное тестирование на файлах из samples/ и больших объемах данных
- [x] **8.5** Создание документации пользователя

#### 10.9 Этап 9: Тестирование и документация
- [ ] **9.1** Unit тесты для всех модулей (coverage ≥80%)
- [x] **9.2** Integration тесты полного workflow
- [x] **9.3** Тестирование на разных ОС (Windows, Linux, macOS)
- [x] **9.4** Создание примеров конфигурации
- [x] **9.5** Финальная документация и release notes

#### 10.10 Этап 10: Оптимизация производительности (Fast Mode)
- [x] **10.1** Разработка системы pre-warming для ускорения запуска
- [x] **10.2** Создание модуля prewarmer.py для предварительной загрузки моделей
- [x] **10.3** Реализация fast_transcriber.py для быстрой обработки
- [x] **10.4** Интеграция быстрого режима в основной transcriber.py (--fast флаг)
- [x] **10.5** Создание скриптов запуска pre-warming для Windows и Linux
- [x] **10.6** Тестирование ускорения (достижение 10-20x speedup)
- [x] **10.7** Документация быстрого режима (FAST_MODE.md)

### 11. ИНСТРУКЦИИ ДЛЯ AI

**Правила отметки выполненных пунктов:**
- ✅ Пункт отмечается как выполненный `[x]` ТОЛЬКО после полной реализации И тестирования
- ⚠️ Частично выполненные пункты остаются как `[ ]` до полного завершения
- 🔄 При обнаружении багов в ранее выполненных пунктах - снимать отметку до исправления
- 📝 При изменении требований - обновлять roadmap и сбрасывать статус затронутых пунктов

**Критерии "выполнено":**
- Код написан и откомментирован на английском языке
- Базовые тесты пройдены успешно
- Модуль интегрирован с остальной системой
- Обработка ошибок реализована
- Логирование добавлено

---

**Версия документа:** 2.0  
**Дата создания:** 29 октября 2025  
**Дата обновления:** 31 октября 2025  
**Статус:** Оптимизирован и готов к использованию
